<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIHAYI: Voice Unchained. Lives Reclaimed.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif; /* Changed font to Montserrat */
            background-color: #fdf8f5; /* Very light peach/cream for a warmer feel */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer shadow */
            padding: 30px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 50%; /* Make it circular */
            object-fit: cover;
        }
        h1, h2, h3 {
            color: #4a4a4a; /* Darker grey for headings */
            margin-bottom: 15px;
        }
        p {
            color: #7a7a7a; /* Medium grey for text */
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .button {
            background-color: #ff7f50; /* Coral for buttons */
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s ease;
            display: inline-block;
            cursor: pointer;
            border: none;
        }
        .button:hover {
            background-color: #ff6347; /* Slightly darker coral on hover */
        }
        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a4a4a;
            font-weight: 500;
        }
        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            color: #4a4a4a;
            background-color: #fcfcfc;
        }
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .link {
            color: #ff7f50;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .link:hover {
            color: #ff6347;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .intro-slides {
            display: flex;
            overflow: hidden;
            width: 100%;
            height: 100%; /* Adjust as needed */
            position: relative;
        }
        .intro-slide {
            min-width: 100%;
            transition: transform 0.5s ease-in-out;
            box-sizing: border-box;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .intro-slide img {
            max-width: 80%;
            height: auto;
            margin-bottom: 20px;
        }
        .progress-dots {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin: 0 5px;
            cursor: pointer;
        }
        .dot.active {
            background-color: #ff7f50;
        }
        .speech-bubble {
            background-color: #f0f0f0;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }
        .speech-bubble p {
            margin-bottom: 5px;
        }
        .speech-bubble .timestamp {
            font-size: 0.8em;
            color: #888;
            text-align: right;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            border: 1px solid;
            display: none; /* Hidden by default */
        }
        .status-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="introScreen" class="screen active">
            <img src="https://via.placeholder.com/100" alt="App Logo" class="mx-auto logo">
            <h1 class="text-3xl font-bold mb-4">RIHAYI: Voice Unchained. Lives Reclaimed.</h1>
            <p>Empowering you with the magic of language, connecting hearts and minds, transcending barriers.</p>

            <div class="intro-slides-container relative w-full overflow-hidden">
                <div class="intro-slides flex transition-transform duration-500 ease-in-out">
                    <div class="intro-slide flex-shrink-0">
                        <h2 class="text-2xl font-semibold mb-4">Choose Your Language</h2>
                        <p>Select the language you'll be speaking and the language you want to hear back in.</p>
                        <div class="input-group w-full mb-4">
                            <label for="inputLanguage">My Language (I speak)</label>
                            <select id="inputLanguage" class="w-full">
                                <option value="en-US">English (US)</option>
                                <option value="hi-IN">Hindi (India)</option>
                                <option value="es-ES">Spanish (Spain)</option>
                                <option value="fr-FR">French (France)</option>
                                </select>
                        </div>
                        <div class="input-group w-full mb-4">
                            <label for="outputLanguage">Output Language (I want to hear)</label>
                            <select id="outputLanguage" class="w-full">
                                <option value="en-US">English (US)</option>
                                <option value="hi-IN">Hindi (India)</option>
                                <option value="es-ES">Spanish (Spain)</option>
                                <option value="fr-FR">French (France)</option>
                                </select>
                        </div>
                        <button id="nextIntroButton1" class="button">Next</button>
                    </div>

                    <div class="intro-slide flex-shrink-0">
                        <img src="https://via.placeholder.com/200x150" alt="Feature 1" class="mx-auto mb-4">
                        <h2 class="text-2xl font-semibold mb-4">Real-time Translation</h2>
                        <p>Speak naturally, and our AI translates instantly, bridging language gaps effortlessly.</p>
                        <button id="nextIntroButton2" class="button">Next</button>
                    </div>

                    <div class="intro-slide flex-shrink-0">
                        <img src="https://via.placeholder.com/200x150" alt="Feature 2" class="mx-auto mb-4">
                        <h2 class="text-2xl font-semibold mb-4">Privacy & Security</h2>
                        <p>Your conversations are protected with advanced encryption and privacy measures.</p>
                        <button id="nextIntroButton3" class="button">Next</button>
                    </div>

                    <div class="intro-slide flex-shrink-0">
                        <img src="https://via.placeholder.com/200x150" alt="Feature 3" class="mx-auto mb-4">
                        <h2 class="text-2xl font-semibold mb-4">Easy to Use</h2>
                        <p>A simple, intuitive interface designed for everyone, everywhere.</p>
                        <button id="nextIntroButton4" class="button">Get Started!</button>
                    </div>
                </div>
            </div>
            <div class="progress-dots"></div>
        </div>

        <div id="loginScreen" class="screen">
            <img src="https://via.placeholder.com/100" alt="App Logo" class="mx-auto logo">
            <h2 class="text-2xl font-semibold mb-6">Welcome Back!</h2>
            <div class="input-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="your@example.com">
            </div>
            <div class="input-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="********">
            </div>
            <button id="loginButton" class="button w-full mb-4">Login</button>
            <p>Don't have an account? <a href="#" id="showSignupLink" class="link">Sign Up</a></p>
        </div>

        <div id="signupScreen" class="screen">
            <img src="https://via.placeholder.com/100" alt="App Logo" class="mx-auto logo">
            <h2 class="text-2xl font-semibold mb-6">Create Your Account</h2>
            <div class="input-group">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" placeholder="your@example.com">
            </div>
            <div class="input-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" placeholder="********">
            </div>
            <button id="signupButton" class="button w-full mb-4">Sign Up</button>
            <p>Already have an account? <a href="#" id="showLoginLink" class="link">Login</a></p>
        </div>

        <div id="chatScreen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Your Chat</h2>
                <button id="logoutButton" class="button button-small bg-gray-300 text-gray-800 px-4 py-2 rounded-full">Logout</button>
            </div>
            <div id="chatHistory" class="border border-gray-200 rounded-lg p-4 h-64 overflow-y-auto mb-4 bg-gray-50 text-left">
                <div class="speech-bubble">
                    <p>Welcome to RIHAYI! Start a conversation.</p>
                    <span class="timestamp">Just now</span>
                </div>
            </div>
            <div class="input-group flex items-center">
                <input type="text" id="chatInput" placeholder="Type your message..." class="flex-grow mr-2">
                <button id="sendChatButton" class="button px-4 py-2">Send</button>
            </div>
             <button id="newConversationButton" class="button mt-4 w-full">Start New Conversation</button>
        </div>

        <div id="aiScreen" class="screen">
            <img src="https://via.placeholder.com/100" alt="AI Icon" class="mx-auto logo mb-4">
            <h2 class="text-2xl font-semibold mb-4">Let's Translate!</h2>
            <p class="mb-4">Click the microphone to start speaking. Click again to stop and translate.</p>
            <button id="microphoneButton" class="button p-4 rounded-full text-4xl">
                <i class="fas fa-microphone"></i>
            </button>
            <p id="speechStatus" class="mt-4 text-gray-600">Click to start speaking...</p>
            <div id="processingIndicator" class="hidden mt-4 text-orange-500 font-semibold">
                Processing...
            </div>
            <div id="transcriptionDisplay" class="mt-4 p-3 bg-gray-100 rounded-lg text-left text-gray-800 min-h-[60px] max-h-[150px] overflow-y-auto border border-gray-200">
                Your speech will appear here.
            </div>
            <div id="aiResponseDisplay" class="mt-4 p-3 bg-orange-50 rounded-lg text-left text-gray-800 min-h-[60px] max-h-[150px] overflow-y-auto border border-orange-200">
                AI response will appear here.
            </div>
            <button id="processButton" class="button mt-6 w-full">Translate and Speak</button>
            <button id="backToChatButton" class="button mt-4 w-full bg-gray-300 text-gray-800">Back to Chat</button>

            <div id="statusMessage" class="status-message mt-4 active" role="alert">
                <p id="statusText">System message or error will appear here.</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script type="module">
        // Global variables for Firebase (MANDATORY TO USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Renamed db to firestoreDb and auth to firebaseAuth to avoid potential global conflicts
        let app, firestoreDb, firebaseAuth, userId;

        // Initialize Firebase if config is available
        if (Object.keys(firebaseConfig).length > 0) {
            app = firebase.initializeApp(firebaseConfig, appId);
            firestoreDb = firebase.firestore(app);
            firebaseAuth = firebase.auth(app);

            // Handle initial authentication token if provided
            if (initialAuthToken) {
                firebaseAuth.signInWithCustomToken(initialAuthToken)
                    .then((userCredential) => {
                        userId = userCredential.user.uid;
                        console.log("Signed in with custom token. User ID:", userId);
                        showScreen(chatScreen);
                    })
                    .catch((error) => {
                        console.error("Error signing in with custom token:", error);
                        displayStatusMessage(`Authentication error: ${error.message}`, "error");
                        showScreen(loginScreen);
                    });
            } else {
                // Monitor auth state changes for regular login/signup
                firebaseAuth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is logged in:", userId);
                        showScreen(chatScreen);
                    } else {
                        userId = null;
                        console.log("No user is logged in.");
                        // Only show login if intro has been seen
                        if (localStorage.getItem('hasSeenIntro') === 'true') {
                             showScreen(loginScreen);
                        }
                    }
                });
            }
        } else {
            console.warn("Firebase configuration not provided. Firebase features will be disabled.");
            displayStatusMessage("Firebase is not configured. Login/Signup and chat history will not function.", "warning");
            // If Firebase is not configured, directly show AI screen for testing AI functionality
            // showScreen(aiScreen); // Consider uncommenting for quick AI testing without auth
        }

        // --- DOM Elements ---
        const introScreen = document.getElementById('introScreen');
        const loginScreen = document.getElementById('loginScreen');
        const signupScreen = document.getElementById('signupScreen');
        const chatScreen = document.getElementById('chatScreen');
        const aiScreen = document.getElementById('aiScreen');

        const showSignupLink = document.getElementById('showSignupLink');
        const showLoginLink = document.getElementById('showLoginLink');

        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');

        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        const signupButton = document.getElementById('signupButton');

        const logoutButton = document.getElementById('logoutButton');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const chatHistoryDiv = document.getElementById('chatHistory');
        const newConversationButton = document.getElementById('newConversationButton');

        const microphoneButton = document.getElementById('microphoneButton');
        const speechStatus = document.getElementById('speechStatus');
        const processingIndicator = document.getElementById('processingIndicator');
        const transcriptionDisplay = document.getElementById('transcriptionDisplay');
        const aiResponseDisplay = document.getElementById('aiResponseDisplay');
        const processButton = document.getElementById('processButton');
        const backToChatButton = document.getElementById('backToChatButton');
        const statusMessageDiv = document.getElementById('statusMessage');
        const statusTextP = document.getElementById('statusText');

        const introSlidesContainer = document.querySelector('.intro-slides');
        const introSlides = document.querySelectorAll('.intro-slide');
        const progressDotsContainer = document.querySelector('.progress-dots');
        const nextIntroButton1 = document.getElementById('nextIntroButton1');
        const nextIntroButton2 = document.getElementById('nextIntroButton2');
        const nextIntroButton3 = document.getElementById('nextIntroButton3');
        const nextIntroButton4 = document.getElementById('nextIntroButton4');
        const inputLanguageSelect = document.getElementById('inputLanguage');
        const outputLanguageSelect = document.getElementById('outputLanguage');

        let currentSlide = 0;
        const totalSlides = introSlides.length;

        // Populate progress dots
        for (let i = 0; i < totalSlides; i++) {
            const dot = document.createElement('span');
            dot.classList.add('dot');
            dot.dataset.slide = i;
            dot.addEventListener('click', () => showIntroSlide(i));
            progressDotsContainer.appendChild(dot);
        }
        const progressDots = document.querySelectorAll('.dot');

        function showIntroSlide(index) {
            currentSlide = index;
            introSlidesContainer.style.transform = `translateX(-${index * 100}%)`;
            progressDots.forEach((dot, i) => {
                if (i === index) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        function nextIntroSlide() {
            if (currentSlide < totalSlides - 1) {
                showIntroSlide(currentSlide + 1);
            } else {
                localStorage.setItem('hasSeenIntro', 'true');
                showScreen(loginScreen);
            }
        }

        function displayStatusMessage(message, type = "info") {
            statusTextP.textContent = message;
            statusMessageDiv.classList.remove("error", "warning", "info");
            statusMessageDiv.classList.add(type, "active");

            // Style based on type
            const errorMessage = document.getElementById('statusMessage');
            if (type === "error") {
                errorMessage.style.backgroundColor = "#ffc2c2";
                errorMessage.style.color = "#990000";
                errorMessage.style.borderColor = "#ff9999";
            } else if (type === "warning") {
                errorMessage.style.backgroundColor = "#ffe9a7";
                errorMessage.style.color = "#a06000";
                errorMessage.style.borderColor = "#ffd76f";
            } else { // info
                errorMessage.style.backgroundColor = "#e6f7f9";
                errorMessage.style.color = "#2196f3";
                errorMessage.style.borderColor = "#90caf9";
            }
        }


        // --- Screen Switching Functionality ---
        function showScreen(screenToShow) {
            const screens = [introScreen, loginScreen, signupScreen, chatScreen, aiScreen];
            screens.forEach(screen => {
                if (screen === screenToShow) {
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });
            // Clear status message when changing screens
            displayStatusMessage("", "info");
            statusMessageDiv.classList.remove("active");
        }

        // --- Event Listeners for Screen Navigation ---
        showSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            showScreen(signupScreen);
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            showScreen(loginScreen);
        });

        if (nextIntroButton1) nextIntroButton1.addEventListener('click', nextIntroSlide);
        if (nextIntroButton2) nextIntroButton2.addEventListener('click', nextIntroSlide);
        if (nextIntroButton3) nextIntroButton3.addEventListener('click', nextIntroSlide);
        if (nextIntroButton4) nextIntroButton4.addEventListener('click', nextIntroSlide);

        // --- Firebase Authentication ---
        if (firebaseAuth) {
            loginButton.addEventListener('click', async () => {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                try {
                    await firebaseAuth.signInWithEmailAndPassword(email, password);
                    displayStatusMessage("Logged in successfully!", "info");
                    // Auth state change listener will handle screen transition
                } catch (error) {
                    console.error("Login error:", error);
                    displayStatusMessage(`Login failed: ${error.message}`, "error");
                }
            });

            signupButton.addEventListener('click', async () => {
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;
                try {
                    await firebaseAuth.createUserWithEmailAndPassword(email, password);
                    displayStatusMessage("Account created successfully!", "info");
                    // Auth state change listener will handle screen transition
                } catch (error) {
                    console.error("Signup error:", error);
                    displayStatusMessage(`Signup failed: ${error.message}`, "error");
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await firebaseAuth.signOut();
                    displayStatusMessage("Logged out successfully!", "info");
                    // Auth state change listener will handle screen transition
                } catch (error) {
                    console.error("Logout error:", error);
                    displayStatusMessage(`Logout failed: ${error.message}`, "error");
                }
            });
        }

        // --- Chat History (Firestore) ---
        let currentConversationId = null; // To manage active conversation
        let unsubscribeFromChat = null; // To store the unsubscribe function for real-time updates

        function loadChatHistory() {
            if (!firestoreDb || !userId) return;

            // Try to load a "default" conversation for the user, or create one if none exists
            // For a real app, you'd manage multiple conversations or use more sophisticated IDs
            const userChatRef = firestoreDb.collection('chats').doc(userId);

            // Unsubscribe from previous listener if exists
            if (unsubscribeFromChat) {
                unsubscribeFromChat();
            }

            unsubscribeFromChat = userChatRef.collection('messages')
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    chatHistoryDiv.innerHTML = ''; // Clear existing messages
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        addMessageToChat(message.text, message.sender === userId ? 'user' : 'ai', message.timestamp);
                    });
                }, error => {
                    console.error("Error loading chat history:", error);
                    displayStatusMessage("Error loading chat history.", "error");
                });

            // Set currentConversationId based on user ID for simplicity
            currentConversationId = userId;
        }

        function addMessageToChat(text, senderType, timestamp) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('speech-bubble', senderType === 'user' ? 'bg-blue-100' : 'bg-gray-100', 'mb-2'); // Tailwind classes
            messageElement.innerHTML = `
                <p>${text}</p>
                <span class="timestamp">${timestamp ? new Date(timestamp.toDate()).toLocaleTimeString() : 'Sending...'}</span>
            `;
            chatHistoryDiv.appendChild(messageElement);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom
        }

        if (sendChatButton) {
            sendChatButton.addEventListener('click', async () => {
                const messageText = chatInput.value.trim();
                if (messageText && firestoreDb && userId && currentConversationId) {
                    chatInput.value = ''; // Clear input

                    // Add user message to UI immediately
                    addMessageToChat(messageText, 'user');

                    try {
                        const chatDocRef = firestoreDb.collection('chats').doc(currentConversationId);
                        const messagesCollectionRef = chatDocRef.collection('messages');

                        await messagesCollectionRef.add({
                            text: messageText,
                            sender: userId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("Message sent to Firestore:", messageText);

                        // If you want to integrate this chat directly with AI, call your AI function here
                        // For example: await sendToGeminiAPI(messageText);

                    } catch (error) {
                        console.error("Error sending message to Firestore:", error);
                        displayStatusMessage("Failed to send message.", "error");
                    }
                }
            });
        }

        if (newConversationButton) {
            newConversationButton.addEventListener('click', () => {
                // For simplicity, just clear UI. For real app, you'd generate a new conversation ID
                chatHistoryDiv.innerHTML = `
                    <div class="speech-bubble">
                        <p>Starting a new conversation. Welcome!</p>
                        <span class="timestamp">Just now</span>
                    </div>
                `;
                displayStatusMessage("Started a new conversation.", "info");
                // If you have a backend, this would trigger creation of a new session/conversation ID
            });
        }

        // When chat screen is activated, load history
        document.addEventListener('screenChange', (e) => {
            if (e.detail.screenId === 'chatScreen' && userId) {
                loadChatHistory();
            }
        });


        // --- Speech Recognition ---
        let recognition;
        let isRecording = false;

        // Check for Web Speech API support
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Set to true for continuous recognition
            recognition.interimResults = true; // Set to true for interim results
            recognition.lang = inputLanguageSelect.value; // Default language

            recognition.onstart = () => {
                isRecording = true;
                speechStatus.textContent = "Listening...";
                microphoneButton.classList.add('animate-pulse', 'text-red-500'); // Visual cue for recording
                transcriptionDisplay.textContent = 'Speak now...';
                displayStatusMessage("Recording started...", "info");
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                transcriptionDisplay.textContent = finalTranscript || interimTranscript;
            };

            recognition.onerror = (event) => {
                isRecording = false;
                speechStatus.textContent = "Error during speech recognition.";
                microphoneButton.classList.remove('animate-pulse', 'text-red-500');
                console.error("Speech recognition error:", event.error);
                displayStatusMessage(`Speech recognition error: ${event.error}`, "error");
            };

            recognition.onend = () => {
                isRecording = false;
                speechStatus.textContent = "Click to start speaking...";
                microphoneButton.classList.remove('animate-pulse', 'text-red-500');
                displayStatusMessage("Recording ended.", "info");
                // Automatically trigger processing when recording stops (if final transcript exists)
                if (transcriptionDisplay.textContent.trim() !== '' && transcriptionDisplay.textContent.trim() !== 'Speak now...') {
                    processButton.click();
                }
            };

            // Update language setting when select box changes
            inputLanguageSelect.addEventListener('change', () => {
                recognition.lang = inputLanguageSelect.value;
                displayStatusMessage(`Input language set to: ${inputLanguageSelect.options[inputLanguageSelect.selectedIndex].text}`, "info");
            });

            microphoneButton.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

        } else {
            speechStatus.textContent = "Speech Recognition not supported in this browser.";
            microphoneButton.disabled = true;
            displayStatusMessage("Speech Recognition is not supported by your browser. Please use Chrome or Edge.", "warning");
        }


        // --- Core AI Processing Logic ---
        processButton.addEventListener('click', async () => {
            const userText = transcriptionDisplay.textContent.trim();
            const selectedOutputLanguage = outputLanguageSelect.value;

            if (userText === '' || userText === 'Speak now...' || userText === 'Your speech will appear here.') {
                displayStatusMessage("Please speak something first!", "warning");
                return;
            }

            processingIndicator.classList.remove('hidden');
            aiResponseDisplay.textContent = 'Thinking...';
            displayStatusMessage("Translating...", "info");

            try {
                // ** IMPORTANT: Replace "YOUR_GENERATED_GOOGLE_API_KEY_HERE" with your actual Gemini API Key **
                const apiKey = "AIzaSyAG6Ska7Q1tzoSsX8w6E5wSAJlyqCHVQzY"; // Get your API key from Google AI Studio: https://aistudio.google.com/
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const llmPrompt = `Translate the following text into ${selectedOutputLanguage} and provide only the translated text. Do not include any additional commentary or formatting. If the input text is empty or unclear, respond with "I didn't catch that. Could you please repeat?"

                User text: "${userText}"`;

                const payload = {
                    contents: [{
                        parts: [{
                            text: llmPrompt
                        }]
                    }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text(); // Read as text to get full error message
                    console.error("API Response Error Body:", errorBody); // Log the raw error body
                    throw new Error(`API error: ${response.status} ${response.statusText}. Details: ${errorBody.substring(0, 200)}...`);
                }

                // Try to parse JSON, if it fails, it's a JSON parse error
                const data = await response.json();
                console.log("Gemini API Response:", data);

                let translatedText = "No translation found.";
                if (data && data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    translatedText = data.candidates[0].content.parts[0].text;
                } else if (data && data.promptFeedback && data.promptFeedback.blockReason) {
                    translatedText = `Content blocked due to safety reasons: ${data.promptFeedback.blockReason}`;
                    displayStatusMessage(translatedText, "warning");
                } else {
                    translatedText = "Could not parse AI response or no translation generated.";
                    displayStatusMessage(translatedText, "warning");
                }

                aiResponseDisplay.textContent = translatedText;
                displayStatusMessage("Translation complete!", "info");

                // Text-to-Speech for the translated text
                if ('speechSynthesis' in window) {
                    const synth = window.speechSynthesis;
                    const utterance = new SpeechSynthesisUtterance(translatedText);
                    utterance.lang = selectedOutputLanguage; // Set speech language to output language
                    synth.speak(utterance);
                    displayStatusMessage("Speaking translation...", "info");
                } else {
                    displayStatusMessage("Text-to-Speech not supported in this browser.", "warning");
                }

            } catch (error) {
                console.error("AI processing error:", error);
                aiResponseDisplay.textContent = "Error: Could not translate.";
                displayStatusMessage(`Error: ${error.message || 'An unknown error occurred.'}`, "error");
            } finally {
                processingIndicator.classList.add('hidden');
            }
        });

        backToChatButton.addEventListener('click', () => {
            showScreen(chatScreen);
        });

        // Initial screen display based on whether user has seen intro
        window.onload = () => {
            if (localStorage.getItem('hasSeenIntro') === 'true') {
                showScreen(loginScreen);
            } else {
                showScreen(introScreen);
                showIntroSlide(0); // Start with the new language selection slide
            }
        };
    </script>

</body>
</html>
